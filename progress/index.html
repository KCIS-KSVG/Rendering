<!--KSVG 项目进展（详情）报告渲染-->
<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KSVG｜文件输出中心</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Poppins:wght@700&display=swap"
        rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@2.5.0/fonts/remixicon.css" rel="stylesheet">
    <link rel="icon" href="https://raw.githubusercontent.com/KCIS-KSVG/Data/main/embed/ksvg-logo.png" type="image/png">
    <style>
        :root {
            --primary-color: #920783;
            --secondary-color: #007bff;
            --dark-gray: #1d1d1f;
            --medium-gray: #424245;
            --light-gray: #f5f5f7;
            --text-color: #1d1d1f;
            --status-ongoing-bg: #e6f7ff;
            --status-ongoing-text: #006d9c;
            --status-completed-bg: #f6ffed;
            --status-completed-text: #389e0d;
            --status-archived-bg: #fafafa;
            --status-archived-text: #8c8c8c;
            --status-planned-bg: #f0f5ff;
            --status-planned-text: #2f54eb;
            --status-cancelled-bg: #fff1f0;
            --status-cancelled-text: #cf1322;
        }

        *,
        *::before,
        *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--light-gray);
            color: var(--text-color);
            line-height: 1.6;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            padding-top: 80px;
        }

        #info-banner {
            display: flex;
            width: 100%;
            max-width: 210mm;
            background-color: #f0f5ff;
            color: #2f54eb;
            border: 1px solid #adc6ff;
            border-radius: 8px;
            padding: 12px 15px;
            margin-bottom: 20px;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
            z-index: 5;
        }

        #info-banner p {
            margin-right: 15px;
        }

        #close-banner-btn {
            background: none;
            border: none;
            font-size: 24px;
            font-weight: bold;
            color: #2f54eb;
            cursor: pointer;
            padding: 0 5px;
            line-height: 1;
        }

        #controls {
            position: fixed;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 10;
        }

        .control-button {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
        }

        .control-button:hover {
            background-color: #f0f0f0;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }

        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(5px);
            z-index: 100;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: opacity 0.3s;
        }

        .loader {
            border: 7px solid #f3f3f3;
            border-top: 7px solid var(--primary-color);
            border-radius: 50%;
            width: 70px;
            height: 70px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        #report-container {
            width: 210mm;
            background: #fff;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            padding: 0.7in;
            display: flex;
            flex-direction: column;
            transform-origin: top center;
            transition: transform 0.2s ease-in-out;
        }

        .error-container {
            text-align: center;
            padding: 40px;
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
            max-width: 600px;
        }

        .error-container i {
            font-size: 60px;
            color: var(--primary-color);
            margin-bottom: 20px;
        }

        .error-container h1 {
            font-family: 'Poppins', sans-serif;
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .error-container p {
            font-size: 1.1rem;
            color: var(--medium-gray);
            margin-bottom: 25px;
        }

        .error-container code {
            background-color: #eee;
            padding: 3px 8px;
            border-radius: 4px;
            font-family: monospace;
        }

        .report-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 15px;
            margin-bottom: 30px;
            border-bottom: 1px solid #ddd;
        }

        .header-text h1 {
            font-family: 'Poppins', sans-serif;
            font-size: 16pt;
            color: #000;
            font-weight: 600;
            margin: 0;
        }

        .header-text h2 {
            font-family: 'Inter', sans-serif;
            font-size: 14pt;
            color: var(--medium-gray);
            font-weight: 600;
            margin: 5px 0 0 0;
        }

        .report-logo {
            height: 60px;
            width: auto;
        }

        .detail-card {
            margin-bottom: 25px;
        }

        .detail-card h3 {
            font-size: 14pt;
            padding-bottom: 8px;
            border-bottom: 1px solid #ccc;
            margin-bottom: 15px;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px 30px;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
            font-size: 10pt;
            page-break-inside: avoid;
        }

        .detail-item .label {
            color: var(--medium-gray);
            font-weight: 600;
            margin-bottom: 5px;
        }

        .detail-item .value {
            color: var(--dark-gray);
            word-break: break-word;
        }

        .detail-item .value.description {
            white-space: pre-wrap;
        }

        .section-divider {
            border: none;
            border-top: 1px solid #eee;
            margin: 25px 0;
        }

        .session-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 20px;
            overflow: hidden;
            page-break-inside: avoid;
        }

        .session-card:last-child {
            margin-bottom: 0;
        }

        .session-header {
            background: #f0f0f0;
            padding: 10px 15px;
            border-bottom: 1px solid #ddd;
        }

        .session-header h4 {
            font-size: 12pt;
            margin: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .session-body {
            padding: 15px;
        }

        .session-body h5 {
            font-size: 11pt;
            margin-top: 15px;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #eee;
        }

        .session-body h5:first-child {
            margin-top: 0;
        }

        .details-table-wrapper {
            overflow-x: auto;
        }

        .details-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 8.5pt;
        }

        .details-table th,
        .details-table td {
            padding: 6px;
            text-align: left;
            border: 1px solid #ddd;
            white-space: nowrap;
            vertical-align: top;
        }

        .details-table th {
            background: #f9f9f9;
            font-weight: 600;
        }

        .details-table td[rowspan] {
            vertical-align: middle;
        }

        .no-data {
            color: var(--medium-gray);
            padding: 15px;
            text-align: center;
        }

        .status-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.9em;
            font-weight: 600;
            white-space: nowrap;
        }

        .session-header .status-badge {
            font-size: 0.8em;
            padding: 2px 6px;
        }

        .status-计划,
        .status-计划中 {
            background-color: var(--status-planned-bg);
            color: var(--status-planned-text);
        }

        .status-进行,
        .status-进行中 {
            background-color: var(--status-ongoing-bg);
            color: var(--status-ongoing-text);
        }

        .status-完成,
        .status-结束,
        .status-已完成,
        .status-提交完成 {
            background-color: var(--status-completed-bg);
            color: var(--status-completed-text);
        }

        .status-归档 {
            background-color: var(--status-archived-bg);
            color: var(--status-archived-text);
        }

        .status-取消 {
            background-color: var(--status-cancelled-bg);
            color: var(--status-cancelled-text);
        }

        @media (max-width: 830px) {
            body {
                padding: 20px;
                padding-top: 20px;
            }

            #controls {
                position: static;
                width: 100%;
                max-width: 100%;
                justify-content: flex-end;
                margin-bottom: 20px;
                flex-wrap: wrap;
            }

            #report-container {
                width: 100%;
                padding: 20px;
                min-height: 0;
            }
        }

        @page {
            size: A4 portrait;
            margin: 0.7in;
        }

        @media print {
            body {
                background: none;
                padding: 0;
            }

            #controls,
            #loading-overlay,
            #info-banner {
                display: none !important;
            }

            #report-container {
                width: 100%;
                max-width: 100%;
                min-height: 0;
                box-shadow: none;
                padding: 0;
                transform: scale(1) !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
        }
    </style>
</head>

<body>
    <div id="info-banner">
        <p><strong>服务提示：</strong>使用不同的浏览器使用该服务可能导致部分输出效果不一致，建议使用 Google Chrome进行渲染。当前因技术问题，无法实现页码标记，敬请谅解。</p>
        <button id="close-banner-btn" title="关闭提示">&times;</button>
    </div>

    <div id="controls">
        <button class="control-button" id="back-button"><i class="ri-arrow-left-line"></i> 返回</button>
        <button class="control-button" id="zoom-out-button"><i class="ri-zoom-out-line"></i> 缩小</button>
        <button class="control-button" id="zoom-reset-button">100%</button>
        <button class="control-button" id="zoom-in-button"><i class="ri-zoom-in-line"></i> 放大</button>
        <button class="control-button" id="print-button"><i class="ri-printer-line"></i> 打印</button>
    </div>
    <div id="loading-overlay">
        <div class="loader"></div>
    </div>
    <div id="report-container"></div>

    <script>
        try {
            document.addEventListener("DOMContentLoaded", function () {
                const BASE_URL = 'https://raw.githubusercontent.com/KCIS-KSVG/Data/main/progress/';
                const URLS = {
                    projects: `${BASE_URL}01.csv`, sessions: `${BASE_URL}02.csv`,
                    setups: `${BASE_URL}03.csv`, products: `${BASE_URL}04.csv`,
                    staff: `${BASE_URL}05.csv`, assets: `${BASE_URL}06.csv`
                };

                const ui = {
                    loadingOverlay: document.getElementById('loading-overlay'),
                    reportContainer: document.getElementById('report-container'),
                    printButton: document.getElementById('print-button'),
                    backButton: document.getElementById('back-button'),
                    infoBanner: document.getElementById('info-banner'),
                    closeBannerBtn: document.getElementById('close-banner-btn'),
                    zoomInButton: document.getElementById('zoom-in-button'),
                    zoomOutButton: document.getElementById('zoom-out-button'),
                    zoomResetButton: document.getElementById('zoom-reset-button'),
                };
                let currentProject = null;
                let projectIdFromUrl = '';
                let currentZoom = 1.0;
                const ZOOM_STEP = 0.1;

                function parseCSV(text) {
                    if (!text) return [];
                    const lines = text.trim().replace(/^\uFEFF/, "").split(/\r?\n/);
                    if (lines.length < 2) return [];
                    const headers = lines[0].split(',').map(h => h.trim());

                    const splitCsvLine = (line) => {
                        const result = [];
                        let current = '';
                        let inQuotes = false;
                        for (const char of line) {
                            if (char === '"' && inQuotes) {
                                if (current.slice(-1) === '"') {
                                    current = current.slice(0, -1) + '"';
                                } else {
                                    inQuotes = !inQuotes;
                                }
                            } else if (char === '"') {
                                inQuotes = !inQuotes;
                            } else if (char === ',' && !inQuotes) {
                                result.push(current.trim());
                                current = '';
                            } else {
                                current += char;
                            }
                        }
                        result.push(current.trim());
                        return result;
                    };

                    return lines.slice(1).map(line => {
                        if (!line.trim()) return null;
                        const values = splitCsvLine(line);
                        return headers.reduce((obj, header, index) => {
                            obj[header] = (values[index] || '').trim();
                            return obj;
                        }, {});
                    }).filter(Boolean);
                }

                async function fetchCSV(url) {
                    const response = await fetch(`${url}?v=${new Date().getTime()}`);
                    if (!response.ok) throw new Error(`Failed to fetch ${url}: ${response.statusText}`);
                    return await response.text();
                }

                async function loadAndRender() {
                    const params = new URLSearchParams(window.location.search);
                    projectIdFromUrl = params.get('id');

                    if (!projectIdFromUrl) {
                        ui.reportContainer.innerHTML = `<div class="error-container"><i class="ri-error-warning-line"></i><h1>无法生成报告</h1><p>URL中缺少必要的项目ID。请通过主页的详情弹窗访问此页面，例如：<br><code>...?id=PRJ-2601</code></p></div>`;
                        ui.loadingOverlay.style.display = 'none';
                        ui.printButton.disabled = true;
                        return;
                    }

                    try {
                        const results = await Promise.allSettled(Object.values(URLS).map(fetchCSV));
                        const [projects, sessions, setups, products, staff, assets] = results.map(res => res.status === 'fulfilled' ? parseCSV(res.value) : []);

                        if (!projects || projects.length === 0) throw new Error("关键文件 '01.csv' (项目) 加载失败或为空。");

                        const targetProject = projects.find(p => p['项目编码（自动）'] === projectIdFromUrl);

                        if (!targetProject) {
                            throw new Error(`项目ID "${projectIdFromUrl}" 未在数据中找到。`);
                        }

                        const staffMap = new Map(staff.map(s => [s['成员编号'], s]));
                        const assetsMap = new Map(assets.map(a => [a['资产编码（自动）'], a]));
                        const productsMap = new Map(products.map(p => [p['产品编码'], p]));
                        const sessionsMap = new Map(sessions.map(s => [s['场次编码（自动）'], s]));
                        const setupsMap = new Map(setups.map(s => [s['机位编码'], s]));

                        const productCodes = (targetProject['产品请求编码（自动）'] || '').split(',').map(s => s.trim()).filter(Boolean);
                        const sessionCodes = (targetProject['附属场次编码（自动）'] || '').split(',').map(s => s.trim()).filter(Boolean);

                        targetProject.products = productCodes.map(code => productsMap.get(code)).filter(Boolean);

                        targetProject.sessions = sessionCodes.map(code => sessionsMap.get(code)).filter(Boolean).map(session => {
                            const setupCodes = (session['机位配置编码（关联）'] || '').split(',').map(s => s.trim()).filter(Boolean);
                            const sessionSetups = setupCodes.map(code => setupsMap.get(code)).filter(Boolean).map(setup => {
                                const staffDetails = staffMap.get(setup['机位负责人编码（自动）']);
                                const assetCodes = (setup['设备配置编码（自动）'] || '').split(',').map(s => s.trim()).filter(Boolean);
                                const setupAssets = assetCodes.map(code => assetsMap.get(code)).filter(Boolean);
                                return { ...setup, staff: staffDetails, assets: setupAssets };
                            });
                            return { ...session, setups: sessionSetups };
                        });

                        currentProject = targetProject;
                        setDocumentTitle(currentProject, false);
                        renderReport(currentProject);

                    } catch (error) {
                        console.error('Data loading or processing failed:', error);
                        ui.reportContainer.innerHTML = `<div class="error-container"><h1>数据加载失败</h1><p style="color: red;">${error.message}</p></div>`;
                        ui.printButton.disabled = true;
                    } finally {
                        ui.loadingOverlay.style.opacity = '0';
                        setTimeout(() => { ui.loadingOverlay.style.display = 'none'; }, 300);
                    }
                }

                function formatDateString(dateStr, includeTime = false) {
                    if (!dateStr || dateStr.toLowerCase() === 'n/a' || dateStr.toLowerCase() === '待通知') return '待通知';
                    try {
                        let date;
                        let matchWithTime = dateStr.match(/(\d{4})年\s*(\d{1,2})月\s*(\d{1,2})日\s*(\d{1,2}):(\d{2})/);
                        if (includeTime && matchWithTime) {
                            const [, year, month, day, hour, minute] = matchWithTime;
                            date = new Date(year, month - 1, day, hour, minute);
                        } else {
                            let matchDateOnly = dateStr.match(/(\d{4})年\s*(\d{1,2})月\s*(\d{1,2})日/);
                            if (matchDateOnly) {
                                const [, year, month, day] = matchDateOnly;
                                date = new Date(year, month - 1, day);
                            } else {
                                date = new Date(dateStr);
                            }
                        }
                        if (isNaN(date.getTime())) return dateStr;
                        const year = date.getFullYear();
                        const month = String(date.getMonth() + 1).padStart(2, '0');
                        const day = String(date.getDate()).padStart(2, '0');
                        if (includeTime) {
                            const hours = String(date.getHours()).padStart(2, '0');
                            const minutes = String(date.getMinutes()).padStart(2, '0');
                            return `${year}年${month}月${day}日 ${hours}:${minutes}`;
                        }
                        return `${year}年${month}月${day}日`;
                    } catch (e) {
                        return dateStr;
                    }
                }

                function renderReport(p) {
                    const createDetailItem = (label, value) => (value || value === 0) ? `<div class="detail-item"><div class="label">${label}</div><div class="value">${value}</div></div>` : '';
                    const createDescriptionItem = (label, value) => value ? `<div class="detail-item"><div class="label">${label}</div><div class="value description">${value}</div></div>` : '';

                    const driveLink = p['项目文稿库（外链）'];
                    const driveLinkHTML = driveLink ? `<a href="${driveLink}" target="_blank">点此查看</a>` : '无';

                    const header = `<div class="report-header"><div class="header-text"><h1>项目详情报告</h1><h2>${p['项目名称']}</h2></div><img src="https://raw.githubusercontent.com/KCIS-KSVG/Data/main/embed/ksvg-service-logo.png" class="report-logo"></div>`;

                    const projectDetails = `<div class="detail-card">
                    <h3>项目详情</h3>
                    <div class="detail-grid">
                        ${createDetailItem('内部编号', p['项目编码（自动）'])}
                        ${createDetailItem('合作部门', p['对接部门'])}
                        ${createDetailItem('状态', `<span class="status-badge status-${p['项目状态']}">${p['项目状态']}</span>`)}
                        ${createDetailItem('开始日期', formatDateString(p['项目开始日期']))}
                        ${createDetailItem('结束日期', formatDateString(p['项目结束日期']))}
                        ${createDetailItem('项目负责人', p['项目负责人'])}
                    </div>
                    <hr class="section-divider">
                    <div class="detail-grid">
                        ${createDetailItem('全局视频规格', p['全局视频规格'])}
                        ${createDetailItem('全局照片规格', p['全局照片规格'])}
                        ${createDetailItem('本地媒体备份', p['本地媒体备份'])}
                    </div>
                    <!-- MODIFIED: Project remarks now in a 3-column grid -->
                    <div class="detail-grid" style="margin-top: 15px;">
                        ${createDetailItem('云端媒体备份', p['云端媒体备份'])}
                        ${createDetailItem('项目文稿库', driveLinkHTML)}
                        ${createDescriptionItem('项目备注', p['项目备注'])}
                    </div>
                </div>`;

                    const productRequests = p.products && p.products.length > 0 ? `<div class="detail-card"><h3>产品请求</h3><div class="details-table-wrapper"><table class="details-table"><thead><tr><th>编号</th><th>类别</th><th>名称/描述</th><th>负责人</th><th>状态</th><th>截止日期</th></tr></thead><tbody>
                    ${p.products.map(pr => `<tr><td>${pr['产品编码']}</td><td>${pr['分类']}</td><td style="white-space:normal;">${pr['需求描述']}</td><td>${pr['产品负责人']}</td><td><span class="status-badge status-${pr['状态']}">${pr['状态']}</span></td><td>${formatDateString(pr['截止日期'])}</td></tr>`).join('')}
                    </tbody></table></div></div>` : '';

                    const sessions = p.sessions && p.sessions.length > 0 ? `<div class="detail-card"><h3>附属场次</h3>
                    ${p.sessions.map(s => {
                        const startDate = formatDateString(s['场次开始时间'], true);
                        const endDate = formatDateString(s['场次结束时间'], true);
                        const dateHTML = startDate === '待通知' && endDate === '待通知' ? '待通知' : `开始: ${startDate}<br>结束: ${endDate}`;
                        const calendarLink = s['关联日程（外链）'] ? `<a href="${s['关联日程（外链）']}" target="_blank">添加到日历</a>` : '无';

                        // --- MODIFIED: Reworked setup table to use rowspan and two equipment columns ---
                        const setupsHTML = `<h5>机位配置</h5>` + (s.setups && s.setups.length > 0
                            ? `<div class="details-table-wrapper"><table class="details-table">
                                <thead><tr><th>机位</th><th>描述</th><th>负责人</th><th>设备名称</th><th>设备编号</th></tr></thead>
                                <tbody>
                                    ${s.setups.map(setup => {
                                const numAssets = setup.assets && setup.assets.length > 0 ? setup.assets.length : 1;
                                const staffName = setup.staff?.['成员姓名'] || '待分配';
                                const firstAsset = setup.assets && setup.assets[0];

                                let rowsHTML = `<tr>
                                            <td rowspan="${numAssets}">${setup['机位序号']}</td>
                                            <td rowspan="${numAssets}">${setup['机位描述']}</td>
                                            <td rowspan="${numAssets}">${staffName}</td>
                                            <td style="white-space:normal;">${firstAsset ? firstAsset['资产描述'] : '未指定'}</td>
                                            <td>${firstAsset ? firstAsset['资产编码（自动）'] : ''}</td>
                                        </tr>`;

                                if (setup.assets && setup.assets.length > 1) {
                                    for (let i = 1; i < setup.assets.length; i++) {
                                        const asset = setup.assets[i];
                                        rowsHTML += `<tr>
                                                    <td style="white-space:normal;">${asset['资产描述']}</td>
                                                    <td>${asset['资产编码（自动）']}</td>
                                                </tr>`;
                                    }
                                }
                                return rowsHTML;
                            }).join('')}
                                </tbody>
                            </table></div>`
                            : '<div class="no-data">无机位配置信息</div>');

                        // --- MODIFIED: Session header simplified; sequence number moved to details ---
                        return `<div class="session-card">
                            <div class="session-header"><h4>${s['场次名称']} (${s['场次编码（自动）']}) <span class="status-badge status-${s['场次状态']}">${s['场次状态']}</span></h4></div>
                            <div class="session-body">
                                <div class="detail-grid" style="margin-bottom: 15px;">
                                    ${createDetailItem('执行地点', s['场次执行地点'])}
                                    ${createDetailItem('场次负责人', s['场次负责人（关联）'])}
                                    ${createDetailItem('场次序号', s['场次序号'])}
                                </div>
                                <div class="detail-grid">
                                    ${createDetailItem('时间', dateHTML)}
                                    ${createDetailItem('日程链接', calendarLink)}
                                    ${createDescriptionItem('场次备注', s['场次备注'])}
                                </div>
                                ${setupsHTML}
                            </div></div>`;
                    }).join('')}
                    </div>` : '';

                    const documentInfo = `<div class="detail-card">
                    <h3>文档信息</h3>
                    <div class="detail-grid" style="grid-template-columns: 1fr;">
                        <div class="detail-item">
                           <div class="label">文件输出时间</div>
                           <div class="value" id="render-timestamp">将在打印时生成</div>
                        </div>
                    </div>
                </div>`;

                    ui.reportContainer.innerHTML = header + '<div class="report-body">' + projectDetails + productRequests + sessions + documentInfo + '</div>';
                }

                function setDocumentTitle(project, isForPrint) {
                    const now = new Date();
                    const pad = (num) => String(num).padStart(2, '0');
                    const filenameTimestamp = `${now.getFullYear()}${pad(now.getMonth() + 1)}${pad(now.getDate())}`;

                    document.title = `项目详情报告_${project['项目编码（自动）']}_${filenameTimestamp}`;

                    if (isForPrint) {
                        const timestamp = `${now.getFullYear()}年${pad(now.getMonth() + 1)}月${pad(now.getDate())}日 ${pad(now.getHours())}时${pad(now.getMinutes())}分${pad(now.getSeconds())}秒`;
                        const timestampElement = ui.reportContainer.querySelector('#render-timestamp');
                        if (timestampElement) {
                            timestampElement.textContent = timestamp;
                        }
                    }
                }

                function prepareAndTriggerPrint() {
                    if (!currentProject) return;
                    setDocumentTitle(currentProject, true);
                    window.print();
                }

                ui.printButton.addEventListener('click', prepareAndTriggerPrint);

                ui.backButton.addEventListener('click', () => {
                    if (projectIdFromUrl) {
                        window.location.href = `https://ksvg.com.cn/progress/?open=${projectIdFromUrl}`;
                    } else {
                        window.location.href = 'https://ksvg.com.cn/progress/';
                    }
                });

                if (ui.closeBannerBtn) {
                    ui.closeBannerBtn.addEventListener('click', () => {
                        ui.infoBanner.style.display = 'none';
                    });
                }

                ui.zoomInButton.addEventListener('click', () => {
                    currentZoom += ZOOM_STEP;
                    ui.reportContainer.style.transform = `scale(${currentZoom})`;
                });
                ui.zoomOutButton.addEventListener('click', () => {
                    currentZoom = Math.max(0.2, currentZoom - ZOOM_STEP);
                    ui.reportContainer.style.transform = `scale(${currentZoom})`;
                });
                ui.zoomResetButton.addEventListener('click', () => {
                    currentZoom = 1.0;
                    ui.reportContainer.style.transform = 'scale(1.0)';
                });

                loadAndRender();
            });
        } catch (e) {
            console.error("A critical error occurred on the page:", e);
            document.getElementById('report-container').innerHTML = `<div class="error-container"><h1>页面脚本发生严重错误</h1><p style="color: red;">请联系管理员。</p></div>`;
            document.getElementById('loading-overlay').style.display = 'none';
        }
    </script>
</body>

</html>